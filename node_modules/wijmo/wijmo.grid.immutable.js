/*!
    *
    * Wijmo Library 5.20231.879
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=null===e?Object.create(e):(__.prototype=e.prototype,new __)}}(),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);e.default=t;return e};Object.defineProperty(exports,"__esModule",{value:!0});var DataChangeAction,wijmo_1=require("wijmo/wijmo"),wijmo_grid_1=require("wijmo/wijmo.grid"),selfModule=__importStar(require("wijmo/wijmo.grid.immutable")),DataChangeEventArgs=function(t){__extends(DataChangeEventArgs,t);function DataChangeEventArgs(e,i,n,r){var o=t.call(this)||this;o.action=e;o.oldItem=i;o.newItem=n;o.itemIndex=r;return o}return DataChangeEventArgs}(wijmo_1.EventArgs);exports.DataChangeEventArgs=DataChangeEventArgs;!function(t){t[t.Add=0]="Add";t[t.Remove=1]="Remove";t[t.Change=2]="Change"}(DataChangeAction=exports.DataChangeAction||(exports.DataChangeAction={}));var CloningItemEventArgs=function(t){__extends(CloningItemEventArgs,t);function CloningItemEventArgs(e){var i=t.call(this)||this;i._originalItem=e;return i}Object.defineProperty(CloningItemEventArgs.prototype,"originalItem",{get:function(){return this._originalItem},enumerable:!0,configurable:!0});return CloningItemEventArgs}(wijmo_1.EventArgs);exports.CloningItemEventArgs=CloningItemEventArgs;var ImmutabilityProvider=function(){function ImmutabilityProvider(t,e){this._isAddNew=!1;this._isPasting=!1;this.dataChanged=new wijmo_1.Event;this.cloningItem=new wijmo_1.Event;wijmo_1.assert(t instanceof wijmo_grid_1.FlexGrid,"FlexGrid component is not specified.");this._grid=t;var i=this._cv=new wijmo_1.CollectionView([]);t.itemsSource=i;t.rowAdded.addHandler(this._gridRowAdded,this);t.deletingRow.addHandler(this._gridDeletingRow,this);t.deletedRow.addHandler(this._gridDeletedRow,this);t.beginningEdit.addHandler(this._gridBeginningEdit,this);t.rowEditEnded.addHandler(this._gridRowEditEnded,this);t.pasting.addHandler(this._gridPasting,this);t.pasted.addHandler(this._gridPasted,this);wijmo_1.copy(this,e)}ImmutabilityProvider.prototype._clearChg=function(){this._isAddNew=this._isPasting=!1;this._chg=this._iChg=null};Object.defineProperty(ImmutabilityProvider.prototype,"grid",{get:function(){return this._grid},enumerable:!0,configurable:!0});Object.defineProperty(ImmutabilityProvider.prototype,"collectionView",{get:function(){return this._cv},enumerable:!0,configurable:!0});Object.defineProperty(ImmutabilityProvider.prototype,"itemsSource",{get:function(){return this._items},set:function(t){wijmo_1.assert(null==t||wijmo_1.isArray(t),"Not an array");if(t!==this._items){this._items=t;var e=this._cv,i=e.sourceCollection,n=e.currentPosition,r=e.currentItem;this._replaceItems(i,t);e.refresh();if(n===e.currentPosition&&r!==e.currentItem){var o=new wijmo_1.CancelEventArgs;e.onCurrentChanging(o);e.onCurrentChanged(o)}}},enumerable:!0,configurable:!0});ImmutabilityProvider.prototype.onDataChanged=function(t){this.dataChanged.raise(this,t)};ImmutabilityProvider.prototype.onCloningItem=function(t){this.cloningItem.raise(this,t)};ImmutabilityProvider.prototype._gridRowAdded=function(t,e){this._isPasting||(this._isAddNew=!0)};ImmutabilityProvider.prototype._gridDeletingRow=function(t,e){if(!this._isAddNew){var i=e.getRow(),n=i.dataItem,r=this._dataIndex(i);this._cv.sourceCollection.indexOf(n);r>-1&&(this._iChg={oldItem:n,index:r})}};ImmutabilityProvider.prototype._gridDeletedRow=function(t,e){var i=this._iChg,n=this._isAddNew;if(i){this._clearChg();n||this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Remove,i.oldItem,null,i.index))}};ImmutabilityProvider.prototype._gridBeginningEdit=function(t,e){if(!this._isAddNew){var i=e.getRow(),n=i.dataItem,r=this._cv.sourceCollection.indexOf(n),o=this._chg;if(o){if(o.changedItems[r])return}else o=this._chg={changedItems:{}};this._addItemChange(i.index,r)}};ImmutabilityProvider.prototype._gridRowEditEnded=function(t,e){this._isPasting||this._doRowEditEnded(t,e)};ImmutabilityProvider.prototype._doRowEditEnded=function(t,e){var i=this._isAddNew,n=this._chg;this._clearChg();if(i){if(!e.cancel){var r=this._cv.sourceCollection,o=r[r.length-1];this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Add,null,o,r.length-1))}}else if(n)if(e.cancel){var a=e.getRow();this._swapBatchedItems(a,n.changedItems)>1&&this._cv.refresh()}else{var s=n.changedItems;for(var d in s){var l=s[d];this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Change,l.oldItem,l.newItem,l.index))}}};ImmutabilityProvider.prototype._gridPasting=function(t,e){this._isPasting=!0;var i=e.range.rowSpan;if(this._chg&&1!==i)e.cancel=!0;else if(1!==i){var n=this._grid.rows,r=e.range.topRow,o=e.range.bottomRow,a=Math.min(n.length-1,o),s=this._cv.sourceCollection;this._chg={changedItems:{},cvLength:s.length};for(var d=r;d<=a;d++){var l=this._dataIndex(n[d]);l>-1&&this._addItemChange(d,l)}}else{this._isPasting=!1;e.getRow()instanceof wijmo_grid_1._NewRowTemplate||this._gridBeginningEdit(t,e)}};ImmutabilityProvider.prototype._gridPasted=function(t,e){var i=this._chg;if(i&&1!==e.range.rowSpan){var n=this._cv.sourceCollection,r=i.cvLength,o=n.slice(r,n.length);this._doRowEditEnded(t,e);for(var a=0;a<o.length;a++)this.onDataChanged(new DataChangeEventArgs(DataChangeAction.Add,null,o[a],r+a))}};ImmutabilityProvider.prototype._swapItem=function(t,e,i,n){var r=t;r&&r.dataItem===n||this._grid.rows.some((function(t){return t.dataItem===n&&!!(r=t)}));var o=this._cv,a=o.sourceCollection.indexOf(n),s=o.items.indexOf(n);e.dataItem=i;r&&(r.dataItem=i);o.sourceCollection[a]=i;o.items[s]=i;return a};ImmutabilityProvider.prototype._swapBatchedItems=function(t,e){var i=Object.keys(e),n=i.length;n>1&&(t=null);for(var r=0,o=i;r<o.length;r++){var a=e[o[r]];this._swapItem(t,a.row,a.oldItem,a.newItem)}return n};ImmutabilityProvider.prototype._addItemChange=function(t,e){var i=this._grid.rows[t],n=i.dataItem,r=this._cloneItem(n);null==e&&(e=this._cv.sourceCollection.indexOf(n));this._chg.changedItems[e]={row:i,oldItem:n,newItem:r,index:e};this._swapItem(i,i,r,n)};ImmutabilityProvider.prototype._dataIndex=function(t){var e=t.dataItem;return e&&!(t instanceof wijmo_grid_1.GroupRow||t instanceof wijmo_grid_1._NewRowTemplate)?this._cv.sourceCollection.indexOf(e):-1};ImmutabilityProvider.prototype._replaceItems=function(t,e){t.splice(0,t.length);for(var i=t.length=e.length,n=0;n<i;n++)t[n]=e[n];return t};ImmutabilityProvider.prototype._cloneItem=function(t){var e=new CloningItemEventArgs(t);this.onCloningItem(e);var i=e.clonedItem;null==i&&(i=this._cloneBindings(t));return i};ImmutabilityProvider.prototype._cloneBindings=function(t){for(var e=copyObject({},t),i={},n=0,r=this.grid.columns;n<r.length;n++){var o=r[n]._binding,a=o&&o._parts;if(a&&a.length>1)for(var s=a.length-2,d=i,l=0;l<=s;l++){var c=a[l];d[c]||(d[c]={});d=d[c]}}this._cloneProps(e,i);return e};ImmutabilityProvider.prototype._cloneProps=function(t,e){for(var i in e){var n=t[i];if(null!=n)if(wijmo_1.isArray(n)){var r=t[i]=[].concat(n);this._cloneProps(r,e[i])}else if(wijmo_1.isObject(n)){r=t[i]=copyObject({},n);this._cloneProps(r,e[i])}}};return ImmutabilityProvider}();exports.ImmutabilityProvider=ImmutabilityProvider;function copyObject(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return _copyImpl.apply(void 0,[t].concat(e))}exports.copyObject=copyObject;var _copyImpl="function"==typeof Object.assign?Object.assign:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var n=0,r=e;n<r.length;n++){var o=r[n];if(null!=o)for(var a in o){var s=Object.getOwnPropertyDescriptor(t,a);s&&!s.writable||(t[a]=o[a])}}return t};wijmo_1._registerModule("wijmo.grid.immutable",selfModule);