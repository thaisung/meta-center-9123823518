/*!
    *
    * Wijmo Library 5.20231.879
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,o=1,r=arguments.length;o<r;o++){t=arguments[o];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("wijmo/wijmo"),selfModule=__importStar(require("wijmo/wijmo.cloud")),OAuth2=function(){function OAuth2(e,t,o,r){var i=this;this.userChanged=new wijmo_1.Event;this.error=new wijmo_1.Event;this._google=window.google;if(this._google)this._initClient(e,t,o);else{var n=document.createElement("script");n.src="https://accounts.google.com/gsi/client";n.onload=function(){return i._initClient(e,t,o)};document.head.appendChild(n)}wijmo_1.copy(this,r)}Object.defineProperty(OAuth2.prototype,"user",{get:function(){return console.warn("Depricated method!")},enumerable:!0,configurable:!0});Object.defineProperty(OAuth2.prototype,"accessToken",{get:function(){return this._access_token?this._access_token:null},enumerable:!0,configurable:!0});Object.defineProperty(OAuth2.prototype,"idToken",{get:function(){return this._token_id?this._token_id:null},enumerable:!0,configurable:!0});OAuth2.prototype.signIn=function(){this._client.requestAccessToken()};OAuth2.prototype.signOut=function(){console.warn("Calling a depricated method!")};OAuth2.prototype.onUserChanged=function(e){this.userChanged.raise(this,e)};OAuth2.prototype.onError=function(e){this.error.raise(this,e)};OAuth2.prototype._initClient=function(e,t,o){var r=this,i=this._google=window.google,n=o&&o.length?o.join(" "):"";n=n||"https://www.googleapis.com/auth/userinfo.email";this._client=i.accounts.oauth2.initTokenClient({client_id:t,scope:n,callback:function(e){r._access_token=e.access_token;r._token_id=e.id_token}})};return OAuth2}();exports.OAuth2=OAuth2;var OAuthError=function(e){__extends(OAuthError,e);function OAuthError(t){var o=e.call(this)||this;o._error=t;return o}Object.defineProperty(OAuthError.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0});return OAuthError}(wijmo_1.EventArgs);exports.OAuthError=OAuthError;var Snapshot=function(e){__extends(Snapshot,e);function Snapshot(t,o){var r=e.call(this)||this;r._loading=!1;r._deferCommits=!1;r._hasPendingChanges=!1;r.loading=new wijmo_1.Event;r.loaded=new wijmo_1.Event;r.error=new wijmo_1.Event;r.hasPendingChangesChanged=new wijmo_1.Event;r._checkType("CollectionReference",t,"firestore","doc","onSnapshot");r._collection=t;wijmo_1.copy(r,o);r.itemsEdited.collectionChanged.addHandler(r._updateHasChanges,r);r.itemsAdded.collectionChanged.addHandler(r._updateHasChanges,r);r.itemsRemoved.collectionChanged.addHandler(r._updateHasChanges,r);r._getData();return r}Object.defineProperty(Snapshot.prototype,"query",{get:function(){return this._query},set:function(e){if(e!=this._query){this._checkType("Query",e,"firestore","onSnapshot");this._query=e;this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(Snapshot.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=wijmo_1.asBoolean(e);this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0});Snapshot.prototype.commitChanges=function(){var e=this;if(this.deferCommits&&this.hasPendingChanges){var t=this._collection.firestore.batch();this.itemsEdited.forEach((function(o){var r=e._getItemDoc(o),i=e._getItemData(o);t.update(r,i)}));this.itemsAdded.forEach((function(o){var r=e._getItemDoc(o),i=e._getItemData(o);t.set(r,i)}));this.itemsRemoved.forEach((function(o){var r=e._getItemDoc(o);t.delete(r)}));t.commit().then((function(){e.clearChanges();e._getData(!0)})).catch((function(t){return e._raiseError(t,!0)}))}};Snapshot.prototype.cancelChanges=function(){if(this.deferCommits){this.clearChanges();this._getData(!0)}};Object.defineProperty(Snapshot.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0});Object.defineProperty(Snapshot.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Snapshot.prototype.load=function(e){this._getData(e)};Snapshot.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Snapshot.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Snapshot.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Snapshot.prototype.onHasPendingChangesChanged=function(e){this.hasPendingChangesChanged.raise(this,e)};Snapshot.prototype.commitNew=function(){var t=this;if(!this.deferCommits){var o=this.currentAddItem;o&&this._collection.add(this._getItemData(o)).catch((function(e){return t._raiseError(e,!0)}))}e.prototype.commitNew.call(this)};Snapshot.prototype.commitEdit=function(){var t=this;if(!this.deferCommits){var o=this.currentEditItem;if(o&&!this.currentAddItem&&this._getChangedFields(o,this._edtClone)){var r=this._getItemDoc(o),i=this._getItemData(o);r.update(i).catch((function(e){return t._raiseError(e,!0)}))}}e.prototype.commitEdit.call(this)};Snapshot.prototype.remove=function(t){var o=this;if(!this.deferCommits&&t&&t!=this.currentAddItem){this._getItemDoc(t).delete().catch((function(e){return o._raiseError(e,!0)}))}e.prototype.remove.call(this,t)};Snapshot.prototype._raiseError=function(e,t){this.onError(new FirestoreErrorEventArgs(e));t&&this._getData(!0)};Snapshot.prototype._updateHasChanges=function(){var e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}};Snapshot.prototype._getItemDoc=function(e){var t=e&&e.$META?e.$META.id:this._generateID();return this._collection.doc(t)};Snapshot.prototype._getItemData=function(e){var t={},o=this.calculatedFields;for(var r in e)o&&r in o||"$META"!=r&&(t[r]=e[r]);return t};Snapshot.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._toGetData=null;t._loading=!0;if(t.onLoading(new wijmo_1.CancelEventArgs)){t._unsubscribe&&t._unsubscribe();t._unsubscribe=t._getQuery().onSnapshot((function(o){var r=[],i=e||!t._loading?t.currentPosition:null;o.forEach((function(e){r.push(__assign({$META:{id:e.id}},e.data()))}));t.sourceCollection=r;null!=i&&t.moveCurrentToPosition(i);if(t._loading){t._loading=!1;t.onLoaded()}}),(function(e){return t._raiseError(e,!0)}))}}),wijmo_1.Control._REFRESH_INTERVAL)};Snapshot.prototype._generateID=function(){for(var e="";e.length<20;)e+=Math.random().toString(36).substr(2,5);return e};Snapshot.prototype._checkType=function(e,t){for(var o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];if(null!=t)for(var i=0;i<o.length;i++){var n=o[i];null==t[n]&&wijmo_1.assert(!1,'Expected "'+e+'" but the value does not have "'+n+'".')}};Snapshot.prototype._getQuery=function(){return this._query||this._collection};return Snapshot}(wijmo_1.CollectionView);exports.Snapshot=Snapshot;var FirestoreErrorEventArgs=function(e){__extends(FirestoreErrorEventArgs,e);function FirestoreErrorEventArgs(t){var o=e.call(this)||this;o._error=t;return o}Object.defineProperty(FirestoreErrorEventArgs.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0});Object.defineProperty(FirestoreErrorEventArgs.prototype,"message",{get:function(){return this._error.message},enumerable:!0,configurable:!0});return FirestoreErrorEventArgs}(wijmo_1.CancelEventArgs);exports.FirestoreErrorEventArgs=FirestoreErrorEventArgs;var Sheet=function(e){__extends(Sheet,e);function Sheet(t,o,r){var i=e.call(this)||this;i._loading=!1;i.loading=new wijmo_1.Event;i.loaded=new wijmo_1.Event;i.error=new wijmo_1.Event;i._gSheet=t;i._title=o;i._id=r;i._getData();t.accessTokenChanged.addHandler((function(){t.accessToken&&!i.items.length&&i._getData(!0)}));return i}Object.defineProperty(Sheet.prototype,"googleSheet",{get:function(){return this._gSheet},enumerable:!0,configurable:!0});Object.defineProperty(Sheet.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0});Sheet.prototype.load=function(e){this._getData(e)};Object.defineProperty(Sheet.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Sheet.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Sheet.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Sheet.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Sheet.prototype.commitNew=function(){var t=this.currentAddItem;t&&this._saveItem(t);e.prototype.commitNew.call(this)};Sheet.prototype.commitEdit=function(){var t=this.currentEditItem;t&&!this.currentAddItem&&this._getChangedFields(t,this._edtClone)&&this._saveItem(t);e.prototype.commitEdit.call(this)};Sheet.prototype.remove=function(t){var o=this;if(t&&t!=this.currentAddItem){var r=this.sourceCollection.indexOf(t);wijmo_1.assert(r>-1,"Item not found.");var i=r+1;wijmo_1.assert(null!=this._id,"Sheet doesn't have an ID ? ");var n=this.googleSheet,s=n._getUrl(":batchUpdate");wijmo_1.httpRequest(s,{method:"POST",requestHeaders:n._getRequestHeaders(),data:{requests:[{deleteDimension:{range:{sheetId:this._id,dimension:"ROWS",startIndex:i,endIndex:i+1}}}]},error:function(e){return o._handleError(e,!1)}})}e.prototype.remove.call(this,t)};Sheet.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._loading=!0;t._itemKeys=null;if(t.onLoading(new wijmo_1.CancelEventArgs)){var o=t.currentPosition,r=t.googleSheet,i=r._getUrl("/values/"+t.title+"!2:2");wijmo_1.httpRequest(i,{requestHeaders:r._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"FORMATTED_STRING"},success:function(i){var n=JSON.parse(i.responseText).values[0],s=r._getUrl("/values/"+t.title);wijmo_1.httpRequest(s,{requestHeaders:r._getRequestHeaders(),data:{valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"SERIAL_NUMBER"},success:function(r){var i=JSON.parse(r.responseText).values;t.sourceCollection=t._parseData(i,n);e&&t.moveCurrentToPosition(o);t._loading=!1;t.onLoaded()},error:function(e){return t._handleError(e,!1)}})},error:function(e){return t._handleError(e,!1)}})}}),wijmo_1.Control._REFRESH_INTERVAL)};Sheet.prototype._parseData=function(e,t){for(var o=[],r=e[0],i=!0,n=0;n<r.length&&i;n++){var s=r[n];s&&wijmo_1.isString(s)&&r.indexOf(s)==n||(i=!1)}if(i)e.splice(0,1);else{var a=[];for(n=0;n<r.length;n++)a.push(this._toSheetHeader(n));r=a}this._itemKeys=r;var l=[],c=this._gSheet.columnDataTypes,h=wijmo_1.DataType;r.forEach((function(e){var t=h.Object;c&&c.forEach((function(o){o.pattern.test(e)&&(t=o.dataType)}));l.push(t)}));e.forEach((function(e){var i={};r.forEach((function(o,r){var n=e[r],s=t[r],a=l[r];a==h.Object&&wijmo_1.isNumber(n)&&wijmo_1.isString(s)&&s.length&&(a=h.Date);a!=h.Object&&(n=a==h.Date&&wijmo_1.isNumber(n)?new Date(86400*(n-25568)*1e3):wijmo_1.changeType(n,a));i[o]=n}));o.push(i)}));return o};Sheet.prototype._toSheetHeader=function(e){return e<26?String.fromCharCode(65+e):this._toSheetHeader(Math.floor(e/26)-1)+this._toSheetHeader(e%26)};Sheet.prototype._saveItem=function(e){var t=this,o=this.sourceCollection.indexOf(e);wijmo_1.assert(o>-1,"Item not found?");var r=[];this._itemKeys.forEach((function(t){var o=e[t];r.push(null!=o?o.toString():"")}));var i=this.googleSheet,n=(o+2).toString(),s=this.title+"!A"+n+":Z"+n,a=i._getUrl("/values/"+s);a+=(a.indexOf("?key=")>-1?"&":"?")+"valueInputOption=USER_ENTERED";wijmo_1.httpRequest(a,{method:"PUT",requestHeaders:i._getRequestHeaders(),data:{range:s,values:[r]},error:function(e){return t._handleError(e,!0)}})};Sheet.prototype._handleError=function(e,t){this.onError(new wijmo_1.RequestErrorEventArgs(e));t&&this._getData(!0)};return Sheet}(wijmo_1.CollectionView);exports.Sheet=Sheet;var GoogleSheet=function(){function GoogleSheet(e,t,o){this._sheetId="";this._accessToken="";this._apiKey="";this._loading=!1;this._sheets=new wijmo_1.ObservableArray;this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this.accessTokenChanged=new wijmo_1.Event;this._sheetId=wijmo_1.asString(e,!1);this._apiKey=wijmo_1.asString(t,!1);wijmo_1.copy(this,o);this._getSheetInfo()}Object.defineProperty(GoogleSheet.prototype,"sheetId",{get:function(){return this._sheetId},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){if(e!=this._accessToken){this._accessToken=wijmo_1.asString(e);this.onAccessTokenChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"columnDataTypes",{get:function(){return this._colTypes},set:function(e){this._colTypes=e},enumerable:!0,configurable:!0});Object.defineProperty(GoogleSheet.prototype,"sheets",{get:function(){return this._sheets},enumerable:!0,configurable:!0});GoogleSheet.prototype.getSheet=function(e){for(var t=0;t<this._sheets.length;t++){var o=this._sheets[t];if(o.title==e)return o}return null};Object.defineProperty(GoogleSheet.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});GoogleSheet.prototype.onLoading=function(e){this.loading.raise(this,e)};GoogleSheet.prototype.onLoaded=function(e){this.loaded.raise(this,e)};GoogleSheet.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};GoogleSheet.prototype.onAccessTokenChanged=function(e){this.accessTokenChanged.raise(this,e)};GoogleSheet.prototype._copy=function(e,t){var o=this;if("sheets"==e&&wijmo_1.isArray(t)){t.forEach((function(e){var t=new Sheet(o,e);o.sheets.push(t)}));return!0}return!1};GoogleSheet.prototype._getUrl=function(e){var t="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId;e&&(t+=e);this.apiKey&&(t+="?key="+this.apiKey);return t};GoogleSheet.prototype._getRequestHeaders=function(){var e={"Content-Type":"application/json"};this.accessToken&&(e.Authorization="Bearer "+this.accessToken);return e};GoogleSheet.prototype._getSheetInfo=function(){var e=this;this._loading=!0;this.onLoading();wijmo_1.httpRequest(this._getUrl(),{requestHeaders:this._getRequestHeaders(),data:{fields:"sheets.properties"},success:function(t){var o=JSON.parse(t.responseText),r=o.sheets;e.sheets.length?e.sheets.forEach((function(e){for(var t=0;t<r.length;t++){var o=r[t].properties;if(o.title==e.title){e._id=o.sheetId;break}}wijmo_1.assert(null!=e._id,'Could not find sheet "'+e.title+'".')})):o.sheets.forEach((function(t){var o=t.properties;if("GRID"==o.sheetType){var r=new Sheet(e,o.title,o.sheetId);e.sheets.push(r)}}))},error:function(t){e.onError(new wijmo_1.RequestErrorEventArgs(t))},complete:function(t){e._loading=!1;e.onLoaded()}})};return GoogleSheet}();exports.GoogleSheet=GoogleSheet;var Firestore=function(){function Firestore(e,t,o){this._projectId="";this._collections=new wijmo_1.ObservableArray;this._accessToken="";this._idToken="";this._fbToken="";this._apiKey="";this.accessTokenChanged=new wijmo_1.Event;this._projectId=wijmo_1.asString(e,!1);this._apiKey=wijmo_1.asString(t,!1);wijmo_1.copy(this,o)}Object.defineProperty(Firestore.prototype,"projectId",{get:function(){return this._projectId},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){if(e!=this._accessToken){this._accessToken=wijmo_1.asString(e);this.onAccessTokenChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"idToken",{get:function(){return this._idToken},set:function(e){var t=this;if(e!=this._idToken){this._idToken=wijmo_1.asString(e);if(this._idToken){var o="https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key="+this._apiKey;wijmo_1.httpRequest(o,{method:"POST",data:{requestUri:window.location.href,postBody:"id_token="+this._idToken+"&providerId=google.com",returnSecureToken:!0,returnIdpCredential:!0},success:function(e){var o=JSON.parse(e.responseText);t._fbToken=o.idToken;t.onAccessTokenChanged()},error:function(e){t._fbToken="";t.onAccessTokenChanged()}})}else{this._fbToken="";this.onAccessTokenChanged()}}},enumerable:!0,configurable:!0});Object.defineProperty(Firestore.prototype,"collections",{get:function(){return this._collections},enumerable:!0,configurable:!0});Firestore.prototype.getCollection=function(e){for(var t=this._collections,o=0;o<t.length;o++){var r=t[o];if(r.name==e)return r}return null};Firestore.prototype.onAccessTokenChanged=function(e){this.accessTokenChanged.raise(this,e)};Firestore.prototype._copy=function(e,t){var o=this;if("collections"==e&&wijmo_1.isArray(t)){t.forEach((function(e){var t=new Collection(o,e);o.collections.push(t)}));return!0}return!1};return Firestore}();exports.Firestore=Firestore;function softGridFilter(){return wijmo_1._getModule("wijmo.grid.filter")}exports.softGridFilter=softGridFilter;var Collection=function(e){__extends(Collection,e);function Collection(t,o,r){var i=e.call(this)||this;i._loading=!1;i._sortOnServer=!1;i._pageOnServer=!1;i._filterOnServer=!1;i._deferCommits=!1;i._hasPendingChanges=!1;i._orderBy=[];i._fieldFilters=[];i._limit=0;i.loading=new wijmo_1.Event;i.loaded=new wijmo_1.Event;i.error=new wijmo_1.Event;i.hasPendingChangesChanged=new wijmo_1.Event;i._store=t;i._name=o;wijmo_1.copy(i,r);i.sortDescriptions.collectionChanged.addHandler((function(){i.sortOnServer&&!i.hasPendingChanges&&i._getData(!0)}));t.accessTokenChanged.addHandler((function(){t.accessToken&&!i.items.length&&i.load()}));i.itemsEdited.collectionChanged.addHandler(i._updateHasChanges,i);i.itemsAdded.collectionChanged.addHandler(i._updateHasChanges,i);i.itemsRemoved.collectionChanged.addHandler(i._updateHasChanges,i);i._getData();return i}Object.defineProperty(Collection.prototype,"store",{get:function(){return this._store},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"fields",{get:function(){return this._fields},set:function(e){if(e!=this._fields){this._fields=wijmo_1.asArray(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"limit",{get:function(){return this._limit},set:function(e){if(e!=this._limit){this._limit=wijmo_1.asInt(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(e){if(e!=this._sortOnServer){this._sortOnServer=wijmo_1.asBoolean(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(e){if(e!=this._pageOnServer){this._pageOnServer=wijmo_1.asBoolean(e);this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(e){if(e!=this._filterOnServer){this._filterOnServer=wijmo_1.asBoolean(e);if(softGridFilter()){null==Collection._filterCulture&&(Collection._filterCulture=wijmo_1.culture.FlexGridFilter);if(this._filterOnServer){var t=wijmo_1.culture.FlexGridFilter;t.stringOperators=t.numberOperators}else wijmo_1.culture.FlexGridFilter=Collection._filterCulture}this._getData(!0)}},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=wijmo_1.asBoolean(e);this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0});Collection.prototype.commitChanges=function(e){var t=this;if(this.deferCommits){var o=[];this.itemsEdited.forEach((function(e){o.push({update:t._itemToDoc(e)})}));this.itemsAdded.forEach((function(e){var r=t._itemToDoc(e);r.name="projects/"+t.store.projectId+"/databases/(default)/documents/"+t.name+"/"+t._generateID();o.push({update:r})}));this.itemsRemoved.forEach((function(e){o.push({delete:e.$META.name})}));o.length&&wijmo_1.httpRequest(this._getUrl(":beginTransaction"),{method:"POST",requestHeaders:this._getRequestHeaders(),success:function(r){var i=JSON.parse(r.responseText);wijmo_1.httpRequest(t._getUrl(":commit"),{method:"POST",data:{writes:o,transaction:i.transaction},requestHeaders:t._getRequestHeaders(),success:function(e){t.clearChanges();t.load()},complete:function(t){wijmo_1.isFunction(e)&&e(t)},error:function(e){return t._raiseError(e,!0)}})},error:function(e){return t._raiseError(e,!0)}})}};Collection.prototype.cancelChanges=function(){if(this.deferCommits){this.clearChanges();this.load()}};Object.defineProperty(Collection.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});Collection.prototype.load=function(e){this._getData(e)};Collection.prototype.select=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.fields=e;return this};Collection.prototype.orderBy=function(e,t){void 0===t&&(t=!0);e?this._orderBy.push(new wijmo_1.SortDescription(wijmo_1.asString(e),wijmo_1.asBoolean(t))):this._orderBy=[];this._getData(!1);return this};Collection.prototype.where=function(e,t,o){if(e){switch(t.toUpperCase()){case"==":t="EQUAL";break;case"!=":t="NOT_EQUAL";break;case">":t="GREATER_THAN";break;case">=":t="GREATER_THAN_OR_EQUAL";break;case"<":t="LESS_THAN";break;case"<=":t="LESS_THAN_OR_EQUAL";break;case"IN":t="IN";wijmo_1.assert(wijmo_1.isArray(o),"IN operator requires array values.");break;default:wijmo_1.assert(!1,"Unknown operator (should be ==, !=, >, >=, <, <=, or IN).")}for(var r=0;r<this._fieldFilters.length;r++){var i=this._fieldFilters[r].fieldFilter;if(i.field.fieldPath==e&&i.op==t){this._fieldFilters.splice(r,1);break}}this._fieldFilters.push({fieldFilter:{field:{fieldPath:e},op:t,value:this._getValueObject(o)}})}else this._fieldFilters=[];this._getData(!1);return this};Collection.prototype.getSubCollection=function(e,t,o){wijmo_1.assert(wijmo_1.isObject(e)&&null!=e.$META,"invalid parent item");var r=new Collection(this.store,t,o);r._parentItem=e;return r};Collection.prototype.onLoading=function(e){this.loading.raise(this,e);return!e.cancel};Collection.prototype.onLoaded=function(e){this.loaded.raise(this,e)};Collection.prototype.onError=function(e){if(this._loading){this._loading=!1;this.onLoaded()}this.error.raise(this,e);return!e.cancel};Collection.prototype.onHasPendingChangesChanged=function(e){this.hasPendingChangesChanged.raise(this,e)};Object.defineProperty(Collection.prototype,"totalItemCount",{get:function(){var e=this._totalCount;return this.pageOnServer?null!=e?e:1e9:this._view?this._view.length:0},set:function(e){this._totalCount=wijmo_1.asInt(e)},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0});Object.defineProperty(Collection.prototype,"pageSize",{get:function(){return this._pgSz},set:function(e){if(e!=this._pgSz){this._pgSz=wijmo_1.asInt(e);if(this.pageOnServer){this._pgIdx=wijmo_1.clamp(this._pgIdx,0,this.pageCount-1);this._getData(!0)}else this.refresh()}},enumerable:!0,configurable:!0});Collection.prototype.onPageChanging=function(t){e.prototype.onPageChanging.call(this,t);!t.cancel&&this.pageOnServer&&(0==this.pageIndex&&0==this.items.length?t.cancel=!0:this._getData(!0));return!t.cancel};Collection.prototype.commitNew=function(){var t=this;if(!this.deferCommits){var o=this.currentAddItem;if(o){var r=this._itemToDoc(o);wijmo_1.httpRequest(this._getUrl(),{method:"POST",data:{fields:r.fields},requestHeaders:this._getRequestHeaders(),success:function(e){var r=JSON.parse(e.responseText);t._saveDocName(r,o);wijmo_1.isNumber(t._totalCount)&&t._totalCount++},error:function(e){return t._raiseError(e,!0)}})}}e.prototype.commitNew.call(this)};Collection.prototype.commitEdit=function(){var t=this;if(!this.deferCommits){var o=this.currentEditItem;if(o&&!this.currentAddItem&&this._getChangedFields(o,this._edtClone)){var r=this._itemToDoc(o);wijmo_1.httpRequest(this._getUrl(r),{method:"PATCH",data:{fields:r.fields},requestHeaders:this._getRequestHeaders(),error:function(e){return t._raiseError(e,!0)}})}}e.prototype.commitEdit.call(this)};Collection.prototype.remove=function(t){var o=this;if(!this.deferCommits&&t&&t!=this.currentAddItem){var r=this._itemToDoc(t);wijmo_1.httpRequest(this._getUrl(r),{method:"DELETE",requestHeaders:this._getRequestHeaders(),success:function(e){wijmo_1.isNumber(o._totalCount)&&o._totalCount--},error:function(e){return o._raiseError(e,!0)}})}e.prototype.remove.call(this,t)};Collection.prototype.updateFilterDefinition=function(e){this._filterProvider=null;if(this.filterOnServer&&softGridFilter()&&e instanceof softGridFilter().FlexGridFilter){this._filterProvider=e;this._totalCount=null;this.moveCurrentToFirst();this._getData(!0)}};Collection.prototype._getPageView=function(){return this.pageOnServer?this._view:e.prototype._getPageView.call(this)};Collection.prototype._generateID=function(){for(var e="";e.length<20;)e+=Math.random().toString(36).substr(2,5);return e};Collection.prototype._updateHasChanges=function(){var e=this.hasPendingChanges;if(e!=this._hasPendingChanges){this._hasPendingChanges=e;this.onHasPendingChangesChanged()}};Collection.prototype._getData=function(e){var t=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){t._toGetData=null;t._loading=!0;if(t.onLoading(new wijmo_1.CancelEventArgs)){var o=t.currentPosition;wijmo_1.httpRequest(t._getUrl(":runQuery"),{method:"POST",data:t._getQuery(),requestHeaders:t._getRequestHeaders(),success:function(r){var i=JSON.parse(r.responseText),n=t._parseData(i),s=t.pageSize;if(t.pageOnServer&&s&&n.length<s){var a=i[0].skippedResults||0;t._totalCount=a+n.length;if(0==n.length&&t.pageIndex>0){t.moveToLastPage();return}}t.sourceCollection=n;e&&t.moveCurrentToPosition(o);t._loading=!1;t.onLoaded()},error:function(e){return t._raiseError(e,!1)}})}}),wijmo_1.Control._REFRESH_INTERVAL)};Collection.prototype._getQuery=function(){var e={from:[{collectionId:this.name}]};this.fields&&this.fields.length&&(e.select={fields:this.fields.map((function(e){return{fieldPath:e}}))});var t=this._fieldFilters;!t.length&&this._filterProvider&&this.filterOnServer&&(t=this._getQueryFilters());t&&t.length&&(e.where=1==t.length?t[0]:{compositeFilter:{filters:t,op:"AND"}});var o=[];t&&t.length&&t.forEach((function(e){var t=e.fieldFilter;"IN"!=t.op&&"EQUAL"!=t.op&&o.push({field:t.field.fieldPath,asc:!0})}));this._orderBy.forEach((function(e){o.push({field:e.property,asc:e.ascending})}));!o.length&&this.sortOnServer&&this.sortDescriptions.forEach((function(e){o.push({field:e.property,asc:e.ascending})}));o.length&&(e.orderBy=o.map((function(e){return{field:{fieldPath:e.field},direction:e.asc?"ASCENDING":"DESCENDING"}})));var r=this.pageSize;if(this.pageOnServer&&r){e.limit=r;e.offset=r*this.pageIndex}!e.limit&&this.limit>0&&(e.limit=this.limit);return{structuredQuery:e}};Collection.prototype._parseData=function(e){var t=this,o=[];wijmo_1.isArray(e)&&e.forEach((function(e){var r=t._docToItem(e);r&&o.push(r)}));return o};Collection.prototype._raiseError=function(e,t){this.onError(new wijmo_1.RequestErrorEventArgs(e));t&&this._getData(!0)};Collection.prototype._saveDocName=function(e,t){if(e.name&&!t.$META){t.$META={name:e.name};return!0}return!1};Collection.prototype._docToItem=function(e){e.name||(e=e.document);if(!e||!e.name)return null;var t={};this._saveDocName(e,t);for(var o in e.fields)t[o]=this._getDocValue(e.fields[o]);return t};Collection.prototype._getDocValue=function(e){var t=this,o=null;for(var r in e){o=e[r];switch(r){case"integerValue":o=parseInt(o);break;case"timestampValue":o=new Date(o);break;case"mapValue":var i={};for(var n in o.fields)i[n]=this._getDocValue(o.fields[n]);o=i;break;case"arrayValue":o=o.values?o.values.map((function(e){return t._getDocValue(e)})):[]}}return o};Collection.prototype._itemToDoc=function(e){var t={},o=e.$META,r=this.calculatedFields;o&&o.name&&(t.name=o.name);t.fields={};for(var i in e)r&&i in r||"$META"!=i&&(t.fields[i]=this._getValueObject(e[i]));return t};Collection.prototype._getValueObject=function(e){var t=this,o={},r=wijmo_1.DataType;switch(wijmo_1.getType(e)){case r.String:o.stringValue=e;break;case r.Boolean:o.booleanValue=e;break;case r.Date:o.timestampValue=e.toJSON();break;case r.Number:e==Math.round(e)?o.integerValue=e.toString():o.doubleValue=e;break;case r.Array:o.arrayValue={values:e.map((function(e){return t._getValueObject(e)}))};break;case r.Object:var i={};for(var n in e)i[n]=this._getValueObject(e[n]);o.mapValue={fields:i};break;default:wijmo_1.assert(!1,"failed to create value object.")}return o};Collection.prototype._getRequestHeaders=function(){var e={},t=this.store._fbToken||this.store.accessToken;t&&(e.Authorization="Bearer "+t);return e};Collection.prototype._getUrl=function(e){var t="https://firestore.googleapis.com/v1/";if(wijmo_1.isObject(e)&&e.name)return t+e.name;e||(e="/"+this.name);return t+(this._parentItem?this._parentItem.$META.name:"projects/"+this.store.projectId+"/databases/(default)/documents")+e};Collection.prototype._getQueryFilters=function(){var e=[],t=this._filterProvider;if(softGridFilter()&&t instanceof softGridFilter().FlexGridFilter)for(var o=0;o<t.grid.columns.length;o++){var r=t.grid.columns[o],i=t.getColumnFilter(r,!1);if(i&&i.isActive){i.conditionFilter&&i.conditionFilter.isActive?this._getQueryConditionFilter(e,i.conditionFilter):i.valueFilter&&i.valueFilter.isActive&&this._getQueryValueFilter(e,i.valueFilter);break}}return e};Collection.prototype._getQueryConditionFilter=function(e,t){var o=t.column.binding,r=this._getQuerySimpleFilter(t.condition1,o),i=this._getQuerySimpleFilter(t.condition2,o);r&&i&&t.and?e.push({compositeFilter:{op:t.and?"AND":"OR",filters:[r,i]}}):r?e.push(r):i&&e.push(i)};Collection.prototype._getQuerySimpleFilter=function(e,t){if(e.isActive){var o=softGridFilter().Operator;return e.operator==o.BW?{compositeFilter:{op:"AND",filters:[{fieldFilter:{field:{fieldPath:t},op:"GREATER_THAN_OR_EQUAL",value:this._getValueObject(e.value)}},{fieldFilter:{field:{fieldPath:t},op:"LESS_THAN",value:this._getValueObject(e.value+"")}}]}}:{fieldFilter:{field:{fieldPath:t},op:this._getFilterOperator(e.operator),value:this._getValueObject(e.value)}}}return null};Collection.prototype._getFilterOperator=function(e){var t=softGridFilter().Operator;switch(e){case t.EQ:return"EQUAL";case t.NE:return"NOT_EQUAL";case t.GE:return"GREATER_THAN_OR_EQUAL";case t.GT:return"GREATER_THAN";case t.LE:return"LESS_THAN_OR_EQUAL";case t.LT:return"LESS_THAN"}wijmo_1.assert(!1,t[e]+" operator not supported (use EQ, NE, GT, GE, LT, or LE)")};Collection.prototype._getQueryValueFilter=function(e,t){var o=t.column,r=o.dataMap,i=[];for(var n in t.showValues){var s=wijmo_1.changeType(n,o.dataType,o.format);r&&wijmo_1.isString(s)&&(s=r.getKeyValue(s));i.push(s);if(i.length>=10)break}i.length&&e.push({fieldFilter:{field:{fieldPath:o.binding},op:"IN",value:this._getValueObject(i)}})};Collection._filterCulture=null;return Collection}(wijmo_1.CollectionView);exports.Collection=Collection;wijmo_1._registerModule("wijmo.cloud",selfModule);